<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .container {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }
        
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .iframe-container {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
        }
        
        .iframe-container.active {
            display: block;
        }
        
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .login-steps {
            margin: 2rem 0;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .step-number {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step-content h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        
        .step-content p {
            margin: 0 0 1rem 0;
            opacity: 0.9;
        }
        
        .login-button, .proceed-button {
            background: #4285f4;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 0.5rem 0;
        }
        
        .login-button:hover {
            background: #3367d6;
        }
        
        .proceed-button {
            background: #34a853;
        }
        
        .proceed-button:hover {
            background: #2d8f47;
        }
        
        .notice {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #ffd700;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container" id="loadingContainer">
        <div class="loading"></div>
        <h2>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</h2>
        <p>URLã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>
    
    <div class="container" id="loginContainer" style="display: none;">
        <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
        <div class="notice">
            <p><strong>ğŸ“± ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆ</strong>ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
            <p><small>âš ï¸ T&Tèªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</small></p>
        </div>
        
        <div class="login-steps">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã§ãƒ­ã‚°ã‚¤ãƒ³</h3>
                    <p>æ–°ã—ã„ã‚¿ãƒ–ã§T&Tãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                    <button class="login-button" onclick="openLoginPage()">
                        ğŸ” T&Tã‚µã‚¤ãƒˆã‚’é–‹ãï¼ˆæ–°ã—ã„ã‚¿ãƒ–ï¼‰
                    </button>
                    <br>
                    <button class="login-button" onclick="openDirectEventPage()" style="background: #ff6b6b; margin-top: 0.5rem;">
                        ğŸŒ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ç›´æ¥é–‹ã
                    </button>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œ</h3>
                    <p>ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ãŸã‚‰ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«é€²ã‚“ã§ãã ã•ã„</p>
                    <button class="proceed-button" onclick="proceedToEvent()">
                        âš”ï¸ ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆã¸é€²ã‚€
                    </button>
                </div>
            </div>
        </div>
        
        <div class="notice" style="margin-top: 2rem;">
            <h4>ğŸ”§ ä»£æ›¿æ‰‹æ®µ</h4>
            <p>ã‚‚ã—ãƒ­ã‚°ã‚¤ãƒ³ãŒã†ã¾ãã„ã‹ãªã„å ´åˆï¼š</p>
            <ul style="text-align: left; margin: 1rem 0;">
                <li>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•ã—ã¦ã¿ã¦ãã ã•ã„</li>
                <li>ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeã€Safariç­‰ï¼‰ã‚’è©¦ã—ã¦ãã ã•ã„</li>
                <li>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</li>
            </ul>
        </div>
        
        <button class="back-button" onclick="goBack()">æˆ»ã‚‹</button>
    </div>

    <div class="container" id="errorContainer" style="display: none;">
        <h2>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
        <div class="error" id="errorMessage">
            ç„¡åŠ¹ãªURLã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚
        </div>
        <button class="back-button" onclick="goBack()">æˆ»ã‚‹</button>
    </div>
    
    <iframe 
        id="targetFrame" 
        class="iframe-container" 
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
        allow="fullscreen"
    ></iframe>

    <script>
        // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
        const SECRET = 'machisaga-secret-key-2025';
        
        // Vercelç’°å¢ƒã§ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('Environment:', window.location.hostname);
        console.log('Current URL:', window.location.href);
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã¨ç½²åã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        
        // Vercelç’°å¢ƒã§ã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆrewriteãƒ«ãƒ¼ãƒ«ã«å¯¾å¿œï¼‰
        let token;
        if (window.location.pathname.startsWith('/redirect/')) {
            token = decodeURIComponent(window.location.pathname.split('/')[2]);
        } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
            token = urlParams.get('token');
        }
        
        const sig = urlParams.get('sig');
        
        // HMAC-SHA256æ¤œè¨¼é–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        async function verifyToken(token, signature) {
            try {
                // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®HMAC-SHA256å®Ÿè£…
                const encoder = new TextEncoder();
                const key = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(SECRET),
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );
                
                const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(token));
                const expectedSignature = Array.from(new Uint8Array(signatureBuffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                console.log('Expected signature:', expectedSignature);
                console.log('Received signature:', signature);
                
                return expectedSignature === signature;
            } catch (error) {
                console.error('Verification error:', error);
                // é–‹ç™ºç’°å¢ƒã§ã¯æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ï¼‰
                console.warn('âš ï¸ é–‹ç™ºç’°å¢ƒ: ç½²åæ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
                return true;
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        async function processRedirect() {
            try {
                console.log('ğŸ” ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†é–‹å§‹');
                console.log('Token:', token);
                console.log('Signature:', sig);
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ã¨ç½²åã®å­˜åœ¨ç¢ºèª
                if (!token || !sig) {
                    throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯ç½²åãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // ç½²åæ¤œè¨¼
                const isValid = await verifyToken(token, sig);
                if (!isValid) {
                    throw new Error('ç½²åæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‡ã‚³ãƒ¼ãƒ‰
                const payload = atob(token);
                console.log('Decoded payload:', payload);
                const [targetUrl, expiresAt] = payload.split('|');
                
                console.log('Target URL:', targetUrl);
                console.log('Expires at:', new Date(parseInt(expiresAt)).toLocaleString('ja-JP'));
                console.log('Current time:', new Date().toLocaleString('ja-JP'));
                
                // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                if (Date.now() > parseInt(expiresAt)) {
                    throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™');
                }
                
                console.log('âœ… æ¤œè¨¼æˆåŠŸï¼ã¾ãšiframeè¡¨ç¤ºã‚’è©¦è¡Œã—ã€å•é¡ŒãŒã‚ã‚Œã°æ–°ã—ã„ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
                
                // ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: ã¾ãšiframeã‚’è©¦è¡Œã—ã€CSPã‚¨ãƒ©ãƒ¼ç­‰ãŒã‚ã‚Œã°æ–°ã—ã„ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                attemptIframeFirst(targetUrl);
                
                console.log('ğŸš€ ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å‡¦ç†å®Œäº†ï¼');
                
            } catch (error) {
                console.error('Redirect error:', error);
                showError(error.message);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            errorMessage.textContent = message;
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆURLã‚’ä¿å­˜
        let currentTargetUrl = '';
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’é–‹ã
        function openLoginPage() {
            console.log('ğŸ” T&Tãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã™');
            window.open('https://play.ttt.games/auth/signin', '_blank', 'width=600,height=700');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ç›´æ¥é–‹ã
        function openDirectEventPage() {
            if (!currentTargetUrl) {
                console.warn('âš ï¸ å¯¾è±¡URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            console.log('ğŸŒ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ç›´æ¥é–‹ãã¾ã™:', currentTargetUrl);
            window.open(currentTargetUrl, '_blank');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«é€²ã‚€
        function proceedToEvent() {
            if (!currentTargetUrl) {
                showError('å¯¾è±¡URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('âš”ï¸ ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«é€²ã¿ã¾ã™:', currentTargetUrl);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loginContainer = document.getElementById('loginContainer');
            const loadingContainer = document.getElementById('loadingContainer');
            
            loginContainer.style.display = 'none';
            loadingContainer.style.display = 'block';
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            const loadingText = loadingContainer.querySelector('p');
            loadingText.textContent = 'ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...';
            
            // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã‹ã‚‰iframeã‚’è¡¨ç¤º
            setTimeout(() => {
                const iframe = document.getElementById('targetFrame');
                
                iframe.src = currentTargetUrl;
                iframe.classList.add('active');
                loadingContainer.style.display = 'none';
                
                console.log('ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸è¡¨ç¤ºå®Œäº†ï¼');
                
                // iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
                iframe.onerror = () => {
                    console.error('iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                    showError('ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                };
            }, 1000);
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
        function showLoginRequired(targetUrl) {
            currentTargetUrl = targetUrl;
            const loadingContainer = document.getElementById('loadingContainer');
            const loginContainer = document.getElementById('loginContainer');
            
            loadingContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            
            console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³æ“ä½œæ¡ˆå†…ã‚’è¡¨ç¤º
        function showLoginInstructions() {
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³æ¡ˆå†…ã‚’è¡¨ç¤º
            const overlay = document.createElement('div');
            overlay.id = 'loginInstructionsOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                color: white;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            overlay.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 2rem;
                    border-radius: 10px;
                    max-width: 500px;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <h2>ğŸ¯ ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ï¼</h2>
                    <p style="margin: 1rem 0; line-height: 1.6;">
                        ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼<br>
                        <strong>ã€Œãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³</strong>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<br>
                        T&Tãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ç™»éŒ²/ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                        <h3>ğŸ“± æ“ä½œæ‰‹é †</h3>
                        <ol style="text-align: left; margin: 0; padding-left: 1.5rem;">
                            <li>é’ã„ã€Œãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li>
                            <li>Googleã¾ãŸã¯Appleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç™»éŒ²/ãƒ­ã‚°ã‚¤ãƒ³</li>
                            <li>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ã§MSCã‚³ã‚¤ãƒ³ã‚’ç²å¾—ï¼</li>
                        </ol>
                    </div>
                    <button onclick="closeLoginInstructions()" style="
                        background: #4285f4;
                        border: none;
                        color: white;
                        padding: 0.75rem 1.5rem;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 1rem;
                        margin-top: 1rem;
                    ">
                        âœ… ç†è§£ã—ã¾ã—ãŸ
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            console.log('ğŸ“± ãƒ­ã‚°ã‚¤ãƒ³æ“ä½œæ¡ˆå†…ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³æ¡ˆå†…ã‚’é–‰ã˜ã‚‹
        function closeLoginInstructions() {
            const overlay = document.getElementById('loginInstructionsOverlay');
            if (overlay) {
                overlay.remove();
                console.log('ğŸ“± ãƒ­ã‚°ã‚¤ãƒ³æ¡ˆå†…ã‚’é–‰ã˜ã¾ã—ãŸ');
            }
        }
        
        // ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ¡ˆå†…ã‚’è¡¨ç¤º
        function showDirectAccessInstructions(targetUrl) {
            currentTargetUrl = targetUrl;
            const loadingContainer = document.getElementById('loadingContainer');
            loadingContainer.style.display = 'none';
            
            // ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ¡ˆå†…ã‚’ä½œæˆ
            const container = document.createElement('div');
            container.className = 'container';
            container.style.cssText = `
                display: block;
                text-align: center;
                max-width: 600px;
                padding: 2rem;
                color: white;
            `;
            
            container.innerHTML = `
                <h2>ğŸ¯ ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ï¼</h2>
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 10px; margin: 2rem 0;">
                    <p style="margin: 0 0 1rem 0; line-height: 1.6; font-size: 1.1rem;">
                        <strong>âœ… URLã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼</strong><br>
                        ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã«ã‚ˆã‚Šã€æ–°ã—ã„ã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã™ã€‚
                    </p>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                        <h3 style="margin: 0 0 1rem 0;">ğŸ“± æ“ä½œæ‰‹é †</h3>
                        <ol style="text-align: left; margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li><strong>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</strong>ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
                            <li><strong>ã€Œãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€</strong>ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li>
                            <li><strong>Googleã¾ãŸã¯Apple</strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç™»éŒ²/ãƒ­ã‚°ã‚¤ãƒ³</li>
                            <li><strong>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†</strong>ã§MSCã‚³ã‚¤ãƒ³ã‚’ç²å¾—ï¼</li>
                        </ol>
                    </div>
                    
                    <button onclick="openEventPageDirectly()" style="
                        background: #4285f4;
                        border: none;
                        color: white;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1.2rem;
                        font-weight: bold;
                        margin: 1rem 0;
                        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#3367d6'" onmouseout="this.style.background='#4285f4'">
                        ğŸš€ ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹ã
                    </button>
                    
                    <p style="margin: 1rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">
                        ğŸ’¡ æ–°ã—ã„ã‚¿ãƒ–ãŒé–‹ã‹ãªã„å ´åˆã¯ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„
                    </p>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                    <h4 style="margin: 0 0 0.5rem 0;">ğŸ”§ ã†ã¾ãã„ã‹ãªã„å ´åˆ</h4>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">
                        â€¢ ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã‚’ç¢ºèª<br>
                        â€¢ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’è©¦ã™<br>
                        â€¢ ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeã€Safariç­‰ï¼‰ã‚’ä½¿ç”¨
                    </p>
                </div>
                
                <button onclick="window.history.back()" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 1rem;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                    â† æˆ»ã‚‹
                </button>
            `;
            
            document.body.appendChild(container);
            console.log('ğŸ¯ ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ¡ˆå†…ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: iframeå„ªå…ˆã€ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ–°ã—ã„ã‚¿ãƒ–
        function attemptIframeFirst(targetUrl) {
            currentTargetUrl = targetUrl;
            
            console.log('ğŸ”’ URLç§˜åŒ¿åŒ–ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€ã¾ãšiframeè¡¨ç¤ºã‚’è©¦è¡Œã—ã¾ã™');
            
            // iframeè¡¨ç¤ºã‚’è©¦è¡Œ
            const iframe = document.getElementById('targetFrame');
            const loadingContainer = document.getElementById('loadingContainer');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            const loadingText = loadingContainer.querySelector('p');
            loadingText.textContent = 'ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...ï¼ˆURLç§˜åŒ¿åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰';
            
            // ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼
            let errorDetected = false;
            let errorTimer = setTimeout(() => {
                if (!errorDetected) {
                    console.warn('âš ï¸ iframeèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - æ–°ã—ã„ã‚¿ãƒ–æ–¹å¼ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
                    errorDetected = true;
                    showUrlExposureWarning(targetUrl);
                }
            }, 10000); // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            
            // CSPã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥
            window.addEventListener('error', function(e) {
                if (e.message.includes('Content Security Policy') || 
                    e.message.includes('CSP') ||
                    e.message.includes('eval')) {
                    console.warn('ğŸš¨ CSPã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ - æ–°ã—ã„ã‚¿ãƒ–æ–¹å¼ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
                    if (!errorDetected) {
                        errorDetected = true;
                        clearTimeout(errorTimer);
                        showUrlExposureWarning(targetUrl);
                    }
                }
            });
            
            // iframeèª­ã¿è¾¼ã¿å‡¦ç†
            iframe.onload = () => {
                if (!errorDetected) {
                    console.log('âœ… iframeèª­ã¿è¾¼ã¿æˆåŠŸ - URLç§˜åŒ¿åŒ–ã‚’ç¶­æŒ');
                    clearTimeout(errorTimer);
                    loadingContainer.style.display = 'none';
                    iframe.classList.add('active');
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³è‡ªå‹•æ“ä½œã‚’è©¦è¡Œ
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (iframeDoc) {
                                const buttons = Array.from(iframeDoc.querySelectorAll('button, a'));
                                const loginBtn = buttons.find(btn => 
                                    btn.textContent.includes('ãƒ­ã‚°ã‚¤ãƒ³') || 
                                    btn.textContent.includes('ç™»éŒ²') ||
                                    btn.textContent.includes('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³')
                                );
                                if (loginBtn) {
                                    console.log('ğŸ¯ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ç™ºè¦‹ - è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œ');
                                    loginBtn.click();
                                } else {
                                    console.log('â„¹ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                                    showIframeLoginInstructions();
                                }
                            }
                        } catch (error) {
                            console.log('ğŸ”’ Cross-originåˆ¶é™ã®ãŸã‚è‡ªå‹•æ“ä½œä¸å¯');
                            showIframeLoginInstructions();
                        }
                    }, 3000);
                }
            };
            
            iframe.onerror = () => {
                if (!errorDetected) {
                    console.error('âŒ iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - æ–°ã—ã„ã‚¿ãƒ–æ–¹å¼ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
                    errorDetected = true;
                    clearTimeout(errorTimer);
                    showUrlExposureWarning(targetUrl);
                }
            };
            
            // iframeè¡¨ç¤ºã‚’è©¦è¡Œ
            iframe.src = targetUrl;
        }
        
        // URLéœ²å‡ºè­¦å‘Šã¨æ–°ã—ã„ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showUrlExposureWarning(targetUrl) {
            const loadingContainer = document.getElementById('loadingContainer');
            loadingContainer.style.display = 'none';
            
            // è­¦å‘Šç”»é¢ã‚’ä½œæˆ
            const warningContainer = document.createElement('div');
            warningContainer.className = 'container';
            warningContainer.style.cssText = `
                display: block;
                text-align: center;
                max-width: 600px;
                padding: 2rem;
                color: white;
            `;
            
            warningContainer.innerHTML = `
                <h2>âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚‹åˆ‡ã‚Šæ›¿ãˆ</h2>
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 10px; margin: 2rem 0;">
                    <p style="margin: 0 0 1rem 0; line-height: 1.6; font-size: 1rem;">
                        <strong>ğŸ”’ URLç§˜åŒ¿åŒ–ã®ç¶­æŒã‚’è©¦ã¿ã¾ã—ãŸãŒ</strong><br>
                        T&Tå´ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã€iframeè¡¨ç¤ºãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
                    </p>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 5px; margin: 1rem 0; border-left: 4px solid #ff9800;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #ff9800;">ğŸ“‹ é‡è¦ãªæ³¨æ„äº‹é …</h3>
                        <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">
                            æ–°ã—ã„ã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ããŸã‚ã€<strong>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«å®Ÿéš›ã®URLãŒè¡¨ç¤º</strong>ã•ã‚Œã¾ã™ã€‚<br>
                            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ã“ã®URLã‚’ä»–ã®äººã¨å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚
                        </p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                        <h3 style="margin: 0 0 1rem 0;">ğŸ“± æ“ä½œæ‰‹é †</h3>
                        <ol style="text-align: left; margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                            <li><strong>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</strong>ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
                            <li><strong>ã€Œãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€</strong>ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li>
                            <li><strong>Googleã¾ãŸã¯Apple</strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç™»éŒ²/ãƒ­ã‚°ã‚¤ãƒ³</li>
                            <li><strong>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†</strong>ã§MSCã‚³ã‚¤ãƒ³ã‚’ç²å¾—ï¼</li>
                        </ol>
                    </div>
                    
                    <button onclick="openEventPageDirectly()" style="
                        background: #ff6b6b;
                        border: none;
                        color: white;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1.2rem;
                        font-weight: bold;
                        margin: 1rem 0;
                        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                        âš ï¸ URLã‚’éœ²å‡ºã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹ã
                    </button>
                    
                    <p style="margin: 1rem 0 0 0; font-size: 0.8rem; opacity: 0.7;">
                        âš ï¸ æ³¨æ„: æ–°ã—ã„ã‚¿ãƒ–ãŒé–‹ã‹ãªã„å ´åˆã¯ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„
                    </p>
                </div>
                
                <button onclick="window.history.back()" style="
                    background: rgba(255, 255, 255, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 1rem;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                    â† æˆ»ã‚‹
                </button>
            `;
            
            document.body.appendChild(warningContainer);
            console.log('âš ï¸ URLéœ²å‡ºè­¦å‘Šã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // iframeå†…ãƒ­ã‚°ã‚¤ãƒ³æ¡ˆå†…
        function showIframeLoginInstructions() {
            showLoginInstructions(); // æ—¢å­˜ã®æ¡ˆå†…ã‚’æµç”¨
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§ç›´æ¥é–‹ãï¼ˆURLéœ²å‡ºï¼‰
        function openEventPageDirectly() {
            if (!currentTargetUrl) {
                console.error('âš ï¸ å¯¾è±¡URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('ğŸš€ æ–°ã—ã„ã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã™ï¼ˆURLéœ²å‡ºï¼‰:', currentTargetUrl);
            
            // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
            const newTab = window.open(currentTargetUrl, '_blank', 'noopener,noreferrer');
            
            if (newTab) {
                console.log('âœ… æ–°ã—ã„ã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸ');
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ff9800;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 5px;
                    z-index: 10000;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                `;
                successMsg.innerHTML = 'âš ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸ<br><small>URLãŒéœ²å‡ºã—ã¦ã„ã¾ã™</small>';
                document.body.appendChild(successMsg);
                
                // 5ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 5000);
            } else {
                console.warn('âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
                alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            window.history.back();
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‡¦ç†é–‹å§‹
        document.addEventListener('DOMContentLoaded', processRedirect);
    </script>
</body>
</html>
