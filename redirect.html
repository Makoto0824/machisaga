<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .container {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }
        
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .iframe-container {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
        }
        
        .iframe-container.active {
            display: block;
        }
        
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .login-steps {
            margin: 2rem 0;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .step-number {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step-content h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        
        .step-content p {
            margin: 0 0 1rem 0;
            opacity: 0.9;
        }
        
        .login-button, .proceed-button {
            background: #4285f4;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 0.5rem 0;
        }
        
        .login-button:hover {
            background: #3367d6;
        }
        
        .proceed-button {
            background: #34a853;
        }
        
        .proceed-button:hover {
            background: #2d8f47;
        }
        
        .notice {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #ffd700;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container" id="loadingContainer">
        <div class="loading"></div>
        <h2>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</h2>
        <p>URLã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>
    
    <div class="container" id="loginContainer" style="display: none;">
        <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
        <div class="notice">
            <p><strong>ğŸ“± ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆ</strong>ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
            <p><small>âš ï¸ T&Tèªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</small></p>
        </div>
        
        <div class="login-steps">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã§ãƒ­ã‚°ã‚¤ãƒ³</h3>
                    <p>æ–°ã—ã„ã‚¿ãƒ–ã§T&Tãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                    <button class="login-button" onclick="openLoginPage()">
                        ğŸ” T&Tã‚µã‚¤ãƒˆã‚’é–‹ãï¼ˆæ–°ã—ã„ã‚¿ãƒ–ï¼‰
                    </button>
                    <br>
                    <button class="login-button" onclick="openDirectEventPage()" style="background: #ff6b6b; margin-top: 0.5rem;">
                        ğŸŒ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ç›´æ¥é–‹ã
                    </button>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œ</h3>
                    <p>ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ãŸã‚‰ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«é€²ã‚“ã§ãã ã•ã„</p>
                    <button class="proceed-button" onclick="proceedToEvent()">
                        âš”ï¸ ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆã¸é€²ã‚€
                    </button>
                </div>
            </div>
        </div>
        
        <div class="notice" style="margin-top: 2rem;">
            <h4>ğŸ”§ ä»£æ›¿æ‰‹æ®µ</h4>
            <p>ã‚‚ã—ãƒ­ã‚°ã‚¤ãƒ³ãŒã†ã¾ãã„ã‹ãªã„å ´åˆï¼š</p>
            <ul style="text-align: left; margin: 1rem 0;">
                <li>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•ã—ã¦ã¿ã¦ãã ã•ã„</li>
                <li>ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeã€Safariç­‰ï¼‰ã‚’è©¦ã—ã¦ãã ã•ã„</li>
                <li>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</li>
            </ul>
        </div>
        
        <button class="back-button" onclick="goBack()">æˆ»ã‚‹</button>
    </div>

    <div class="container" id="errorContainer" style="display: none;">
        <h2>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
        <div class="error" id="errorMessage">
            ç„¡åŠ¹ãªURLã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚
        </div>
        <button class="back-button" onclick="goBack()">æˆ»ã‚‹</button>
    </div>
    
    <iframe 
        id="targetFrame" 
        class="iframe-container" 
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
        allow="fullscreen"
    ></iframe>

    <script>
        // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
        const SECRET = 'machisaga-secret-key-2025';
        
        // Vercelç’°å¢ƒã§ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('Environment:', window.location.hostname);
        console.log('Current URL:', window.location.href);
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã¨ç½²åã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        
        // Vercelç’°å¢ƒã§ã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆrewriteãƒ«ãƒ¼ãƒ«ã«å¯¾å¿œï¼‰
        let token;
        if (window.location.pathname.startsWith('/redirect/')) {
            token = decodeURIComponent(window.location.pathname.split('/')[2]);
        } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
            token = urlParams.get('token');
        }
        
        const sig = urlParams.get('sig');
        
        // HMAC-SHA256æ¤œè¨¼é–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        async function verifyToken(token, signature) {
            try {
                // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®HMAC-SHA256å®Ÿè£…
                const encoder = new TextEncoder();
                const key = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(SECRET),
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );
                
                const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(token));
                const expectedSignature = Array.from(new Uint8Array(signatureBuffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                console.log('Expected signature:', expectedSignature);
                console.log('Received signature:', signature);
                
                return expectedSignature === signature;
            } catch (error) {
                console.error('Verification error:', error);
                // é–‹ç™ºç’°å¢ƒã§ã¯æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ï¼‰
                console.warn('âš ï¸ é–‹ç™ºç’°å¢ƒ: ç½²åæ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
                return true;
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        async function processRedirect() {
            try {
                console.log('ğŸ” ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†é–‹å§‹');
                console.log('Token:', token);
                console.log('Signature:', sig);
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ã¨ç½²åã®å­˜åœ¨ç¢ºèª
                if (!token || !sig) {
                    throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯ç½²åãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // ç½²åæ¤œè¨¼
                const isValid = await verifyToken(token, sig);
                if (!isValid) {
                    throw new Error('ç½²åæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‡ã‚³ãƒ¼ãƒ‰
                const payload = atob(token);
                console.log('Decoded payload:', payload);
                const [targetUrl, expiresAt] = payload.split('|');
                
                console.log('Target URL:', targetUrl);
                console.log('Expires at:', new Date(parseInt(expiresAt)).toLocaleString('ja-JP'));
                console.log('Current time:', new Date().toLocaleString('ja-JP'));
                
                // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                if (Date.now() > parseInt(expiresAt)) {
                    throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™');
                }
                
                console.log('âœ… æ¤œè¨¼æˆåŠŸï¼ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™');
                
                // T&Tèªè¨¼ã«å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ–¹å¼ã«å¤‰æ›´
                // showLoginRequired(targetUrl);
                
                // ç›´æ¥iframeã§è¡¨ç¤º
                const iframe = document.getElementById('targetFrame');
                const loadingContainer = document.getElementById('loadingContainer');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
                const loadingText = loadingContainer.querySelector('p');
                loadingText.textContent = 'ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                
                // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã‹ã‚‰iframeã‚’è¡¨ç¤º
                setTimeout(() => {
                    iframe.src = targetUrl;
                    iframe.classList.add('active');
                    loadingContainer.style.display = 'none';
                    
                    console.log('ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ç›´æ¥è¡¨ç¤ºå®Œäº†ï¼');
                    
                    // iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
                    iframe.onerror = () => {
                        console.error('iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º');
                        showLoginRequired(targetUrl);
                    };
                    
                    // iframeèª­ã¿è¾¼ã¿å®Œäº†ãƒã‚§ãƒƒã‚¯
                    iframe.onload = () => {
                        console.log('ğŸ¯ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
                        // ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªå ´åˆã¯å†…å®¹ãŒç©ºã«ãªã‚‹ã¯ãš
                        setTimeout(() => {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (!iframeDoc || iframeDoc.body.innerHTML.trim() === '') {
                                    console.warn('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
                                    showLoginRequired(targetUrl);
                                }
                            } catch (error) {
                                console.log('ğŸ”’ Cross-originåˆ¶é™ã®ãŸã‚å†…å®¹ç¢ºèªä¸å¯ï¼ˆæ­£å¸¸ï¼‰');
                            }
                        }, 2000);
                    };
                }, 1000);
                
                console.log('ğŸš€ ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å‡¦ç†å®Œäº†ï¼');
                
            } catch (error) {
                console.error('Redirect error:', error);
                showError(error.message);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            errorMessage.textContent = message;
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆURLã‚’ä¿å­˜
        let currentTargetUrl = '';
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’é–‹ã
        function openLoginPage() {
            console.log('ğŸ” T&Tãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã™');
            window.open('https://play.ttt.games/auth/signin', '_blank', 'width=600,height=700');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ç›´æ¥é–‹ã
        function openDirectEventPage() {
            if (!currentTargetUrl) {
                console.warn('âš ï¸ å¯¾è±¡URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            console.log('ğŸŒ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’ç›´æ¥é–‹ãã¾ã™:', currentTargetUrl);
            window.open(currentTargetUrl, '_blank');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«é€²ã‚€
        function proceedToEvent() {
            if (!currentTargetUrl) {
                showError('å¯¾è±¡URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('âš”ï¸ ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«é€²ã¿ã¾ã™:', currentTargetUrl);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loginContainer = document.getElementById('loginContainer');
            const loadingContainer = document.getElementById('loadingContainer');
            
            loginContainer.style.display = 'none';
            loadingContainer.style.display = 'block';
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            const loadingText = loadingContainer.querySelector('p');
            loadingText.textContent = 'ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...';
            
            // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã‹ã‚‰iframeã‚’è¡¨ç¤º
            setTimeout(() => {
                const iframe = document.getElementById('targetFrame');
                
                iframe.src = currentTargetUrl;
                iframe.classList.add('active');
                loadingContainer.style.display = 'none';
                
                console.log('ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸è¡¨ç¤ºå®Œäº†ï¼');
                
                // iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
                iframe.onerror = () => {
                    console.error('iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                    showError('ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                };
            }, 1000);
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
        function showLoginRequired(targetUrl) {
            currentTargetUrl = targetUrl;
            const loadingContainer = document.getElementById('loadingContainer');
            const loginContainer = document.getElementById('loginContainer');
            
            loadingContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            
            console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            window.history.back();
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‡¦ç†é–‹å§‹
        document.addEventListener('DOMContentLoaded', processRedirect);
    </script>
</body>
</html>
