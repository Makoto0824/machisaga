<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リダイレクト中...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .container {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }
        
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .iframe-container {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
        }
        
        .iframe-container.active {
            display: block;
        }
        
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .login-steps {
            margin: 2rem 0;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .step-number {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step-content h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        
        .step-content p {
            margin: 0 0 1rem 0;
            opacity: 0.9;
        }
        
        .login-button, .proceed-button {
            background: #4285f4;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 0.5rem 0;
        }
        
        .login-button:hover {
            background: #3367d6;
        }
        
        .proceed-button {
            background: #34a853;
        }
        
        .proceed-button:hover {
            background: #2d8f47;
        }
        
        .notice {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #ffd700;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container" id="loadingContainer">
        <div class="loading"></div>
        <h2>リダイレクト中...</h2>
        <p>URLを検証しています。しばらくお待ちください。</p>
    </div>
    
    <div class="container" id="loginContainer" style="display: none;">
        <h2>🔐 ログインが必要です</h2>
        <div class="notice">
            <p><strong>📱 まちサーガイベント</strong>にアクセスするにはログインが必要です。</p>
            <p><small>⚠️ T&T認証サービスに一時的な問題が発生している可能性があります。</small></p>
        </div>
        
        <div class="login-steps">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>別のブラウザタブでログイン</h3>
                    <p>新しいタブでT&Tプラットフォームにログインしてください</p>
                    <button class="login-button" onclick="openLoginPage()">
                        🔐 T&Tサイトを開く（新しいタブ）
                    </button>
                    <br>
                    <button class="login-button" onclick="openDirectEventPage()" style="background: #ff6b6b; margin-top: 0.5rem;">
                        🌐 イベントページを直接開く
                    </button>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>ログイン完了後</h3>
                    <p>ログインが完了したら、下のボタンでまちサーガイベントページに進んでください</p>
                    <button class="proceed-button" onclick="proceedToEvent()">
                        ⚔️ まちサーガイベントへ進む
                    </button>
                </div>
            </div>
        </div>
        
        <div class="notice" style="margin-top: 2rem;">
            <h4>🔧 代替手段</h4>
            <p>もしログインがうまくいかない場合：</p>
            <ul style="text-align: left; margin: 1rem 0;">
                <li>ブラウザを再起動してみてください</li>
                <li>他のブラウザ（Chrome、Safari等）を試してください</li>
                <li>プライベート/シークレットモードでアクセスしてください</li>
            </ul>
        </div>
        
        <button class="back-button" onclick="goBack()">戻る</button>
    </div>

    <div class="container" id="errorContainer" style="display: none;">
        <h2>⚠️ エラーが発生しました</h2>
        <div class="error" id="errorMessage">
            無効なURLまたは期限切れです。
        </div>
        <button class="back-button" onclick="goBack()">戻る</button>
    </div>
    
    <iframe 
        id="targetFrame" 
        class="iframe-container" 
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
        allow="fullscreen"
    ></iframe>

    <script>
        // シークレットキー（本番環境では環境変数から取得）
        const SECRET = 'machisaga-secret-key-2025';
        
        // Vercel環境でのデバッグ情報
        console.log('Environment:', window.location.hostname);
        console.log('Current URL:', window.location.href);
        
        // URLパラメータからトークンと署名を取得
        const urlParams = new URLSearchParams(window.location.search);
        
        // Vercel環境でのトークン取得（rewriteルールに対応）
        let token;
        if (window.location.pathname.startsWith('/redirect/')) {
            token = decodeURIComponent(window.location.pathname.split('/')[2]);
        } else {
            // フォールバック: URLパラメータから取得
            token = urlParams.get('token');
        }
        
        const sig = urlParams.get('sig');
        
        // HMAC-SHA256検証関数（簡易版）
        async function verifyToken(token, signature) {
            try {
                // ブラウザ環境でのHMAC-SHA256実装
                const encoder = new TextEncoder();
                const key = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(SECRET),
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );
                
                const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(token));
                const expectedSignature = Array.from(new Uint8Array(signatureBuffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                console.log('Expected signature:', expectedSignature);
                console.log('Received signature:', signature);
                
                return expectedSignature === signature;
            } catch (error) {
                console.error('Verification error:', error);
                // 開発環境では検証をスキップ（本番環境では削除）
                console.warn('⚠️ 開発環境: 署名検証をスキップします');
                return true;
            }
        }
        
        // メイン処理
        async function processRedirect() {
            try {
                console.log('🔍 リダイレクト処理開始');
                console.log('Token:', token);
                console.log('Signature:', sig);
                
                // トークンと署名の存在確認
                if (!token || !sig) {
                    throw new Error('トークンまたは署名が不足しています');
                }
                
                // 署名検証
                const isValid = await verifyToken(token, sig);
                if (!isValid) {
                    throw new Error('署名検証に失敗しました');
                }
                
                // トークンデコード
                const payload = atob(token);
                console.log('Decoded payload:', payload);
                const [targetUrl, expiresAt] = payload.split('|');
                
                console.log('Target URL:', targetUrl);
                console.log('Expires at:', new Date(parseInt(expiresAt)).toLocaleString('ja-JP'));
                console.log('Current time:', new Date().toLocaleString('ja-JP'));
                
                // 有効期限チェック
                if (Date.now() > parseInt(expiresAt)) {
                    throw new Error('トークンの有効期限が切れています');
                }
                
                console.log('✅ 検証成功！まちサーガイベントページに直接アクセスします');
                
                // T&T認証に問題があるため、直接アクセス方式に変更
                // showLoginRequired(targetUrl);
                
                // 直接iframeで表示
                const iframe = document.getElementById('targetFrame');
                const loadingContainer = document.getElementById('loadingContainer');
                
                // ローディングメッセージを更新
                const loadingText = loadingContainer.querySelector('p');
                loadingText.textContent = 'まちサーガイベントページを読み込み中...';
                
                // 少し遅延を入れてからiframeを表示
                setTimeout(() => {
                    iframe.src = targetUrl;
                    iframe.classList.add('active');
                    loadingContainer.style.display = 'none';
                    
                    console.log('🎉 イベントページ直接表示完了！');
                    
                    // iframe読み込みエラーをキャッチ
                    iframe.onerror = () => {
                        console.error('iframe読み込みエラー - ログイン画面を表示');
                        showLoginRequired(targetUrl);
                    };
                    
                    // iframe読み込み完了チェック
                    iframe.onload = () => {
                        console.log('🎯 イベントページ読み込み完了');
                        // ログインが必要な場合は内容が空になるはず
                        setTimeout(() => {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (!iframeDoc || iframeDoc.body.innerHTML.trim() === '') {
                                    console.warn('🔐 ログインが必要な可能性があります');
                                    showLoginRequired(targetUrl);
                                }
                            } catch (error) {
                                console.log('🔒 Cross-origin制限のため内容確認不可（正常）');
                            }
                        }, 2000);
                    };
                }, 1000);
                
                console.log('🚀 直接アクセス処理完了！');
                
            } catch (error) {
                console.error('Redirect error:', error);
                showError(error.message);
            }
        }
        
        // エラー表示
        function showError(message) {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            errorMessage.textContent = message;
        }
        
        // グローバル変数でターゲットURLを保存
        let currentTargetUrl = '';
        
        // ログインページを開く
        function openLoginPage() {
            console.log('🔐 T&Tログインページを開きます');
            window.open('https://play.ttt.games/auth/signin', '_blank', 'width=600,height=700');
        }
        
        // イベントページを直接開く
        function openDirectEventPage() {
            if (!currentTargetUrl) {
                console.warn('⚠️ 対象URLが設定されていません');
                return;
            }
            console.log('🌐 イベントページを直接開きます:', currentTargetUrl);
            window.open(currentTargetUrl, '_blank');
        }
        
        // イベントページに進む
        function proceedToEvent() {
            if (!currentTargetUrl) {
                showError('対象URLが設定されていません');
                return;
            }
            
            console.log('⚔️ まちサーガイベントページに進みます:', currentTargetUrl);
            
            // ローディング表示
            const loginContainer = document.getElementById('loginContainer');
            const loadingContainer = document.getElementById('loadingContainer');
            
            loginContainer.style.display = 'none';
            loadingContainer.style.display = 'block';
            
            // ローディングメッセージを更新
            const loadingText = loadingContainer.querySelector('p');
            loadingText.textContent = 'まちサーガイベントページを読み込み中...';
            
            // 少し遅延を入れてからiframeを表示
            setTimeout(() => {
                const iframe = document.getElementById('targetFrame');
                
                iframe.src = currentTargetUrl;
                iframe.classList.add('active');
                loadingContainer.style.display = 'none';
                
                console.log('🎉 イベントページ表示完了！');
                
                // iframe読み込みエラーをキャッチ
                iframe.onerror = () => {
                    console.error('iframe読み込みエラー');
                    showError('イベントページの読み込みに失敗しました。ログインが完了していない可能性があります。');
                };
            }, 1000);
        }
        
        // ログイン画面を表示
        function showLoginRequired(targetUrl) {
            currentTargetUrl = targetUrl;
            const loadingContainer = document.getElementById('loadingContainer');
            const loginContainer = document.getElementById('loginContainer');
            
            loadingContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            
            console.log('🔐 ログイン必須画面を表示しました');
        }
        
        // 戻るボタン
        function goBack() {
            window.history.back();
        }
        
        // ページ読み込み時に処理開始
        document.addEventListener('DOMContentLoaded', processRedirect);
    </script>
</body>
</html>
