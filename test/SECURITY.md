# セキュリティ対策ガイド

## トークン付きリダイレクトシステム

### 🔒 実装済みセキュリティ対策

#### 1. トークン署名検証

- **HMAC-SHA256**: トークンの改ざんを防止
- **署名検証**: サーバー側とクライアント側で二重検証
- **Base64 エンコード**: トークンの可読性を下げる

#### 2. 有効期限制御

- **短期トークン**: デフォルト 5 分の有効期限
- **時刻検証**: サーバー時刻との照合
- **自動無効化**: 期限切れトークンの自動拒否

#### 3. iframe セキュリティ

- **sandbox 属性**: 外部サイトの動作を制限
  - `allow-scripts`: スクリプト実行許可
  - `allow-same-origin`: 同一オリジン許可
  - `allow-forms`: フォーム送信許可
  - `allow-popups`: ポップアップ許可（制限付き）
- **X-Frame-Options 対応**: 外部サイトの制限に準拠

#### 4. エラーハンドリング

- **詳細情報の非表示**: エラー内容を一般化
- **ログ記録**: セキュリティイベントの記録
- **適切な HTTP ステータス**: セキュリティに配慮したレスポンス

### ⚠️ 注意事項

#### 1. 環境変数の管理

```bash
# 本番環境では必ず強力なシークレットキーを設定
SECRET=your-super-secret-key-here-2025
```

#### 2. ドメイン制限（推奨）

```bash
# 許可するドメインを制限
ALLOWED_DOMAINS=https://example.com,https://test.com
```

#### 3. HTTPS 必須

- 本番環境では必ず HTTPS を使用
- トークンの盗聴を防止

#### 4. ログ監視

- 異常なアクセスパターンの監視
- トークン生成頻度の監視
- エラー率の監視

### 🚨 既知の制限事項

#### 1. X-Frame-Options

- 外部サイトが`X-Frame-Options: DENY`を設定している場合、iframe 表示不可
- 代替案: リダイレクト方式への変更

#### 2. CSP（Content Security Policy）

- 外部サイトの CSP が厳しい場合、表示に影響する可能性
- 対応: 外部サイト側での CSP 調整が必要

#### 3. トークン漏洩リスク

- URL の漏洩によりトークンが露出する可能性
- 対策: より短い有効期限、使用回数制限

### 🔧 追加セキュリティ対策（推奨）

#### 1. レート制限

```javascript
// API呼び出し頻度制限
const rateLimit = {
  windowMs: 15 * 60 * 1000, // 15分
  max: 100, // 最大100回
};
```

#### 2. IP 制限

```javascript
// 許可IPアドレスの制限
const allowedIPs = ["192.168.1.0/24", "10.0.0.0/8"];
```

#### 3. 使用回数制限

```javascript
// トークンの使用回数制限
const maxUsage = 1; // 1回のみ使用可能
```

#### 4. 監査ログ

```javascript
// セキュリティイベントの記録
const auditLog = {
  timestamp: new Date(),
  action: "token_generated",
  ip: req.ip,
  userAgent: req.headers["user-agent"],
};
```

### 📋 セキュリティチェックリスト

- [ ] 強力なシークレットキーの設定
- [ ] HTTPS の使用
- [ ] 環境変数の適切な管理
- [ ] ログ監視の実装
- [ ] レート制限の実装
- [ ] 定期的なセキュリティ監査
- [ ] 外部サイトのセキュリティポリシー確認
- [ ] エラーメッセージの一般化
- [ ] トークン有効期限の適切な設定
- [ ] iframe セキュリティ属性の確認
