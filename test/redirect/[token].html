<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .container {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }
        
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .iframe-container {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
        }
        
        .iframe-container.active {
            display: block;
        }
        
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container" id="loadingContainer">
        <div class="loading"></div>
        <h2>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</h2>
        <p>URLã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>
    
    <div class="container" id="errorContainer" style="display: none;">
        <h2>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
        <div class="error" id="errorMessage">
            ç„¡åŠ¹ãªURLã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚
        </div>
        <button class="back-button" onclick="goBack()">æˆ»ã‚‹</button>
    </div>
    
    <iframe 
        id="targetFrame" 
        class="iframe-container" 
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
        allow="fullscreen"
    ></iframe>

    <script>
        // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
        const SECRET = 'machisaga-secret-key-2025';
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã¨ç½²åã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const token = decodeURIComponent(window.location.pathname.split('/')[2]);
        const sig = urlParams.get('sig');
        
        // HMAC-SHA256æ¤œè¨¼é–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        async function verifyToken(token, signature) {
            try {
                // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®HMAC-SHA256å®Ÿè£…
                const encoder = new TextEncoder();
                const key = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(SECRET),
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );
                
                const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(token));
                const expectedSignature = Array.from(new Uint8Array(signatureBuffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                console.log('Expected signature:', expectedSignature);
                console.log('Received signature:', signature);
                
                return expectedSignature === signature;
            } catch (error) {
                console.error('Verification error:', error);
                // é–‹ç™ºç’°å¢ƒã§ã¯æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ï¼‰
                console.warn('âš ï¸ é–‹ç™ºç’°å¢ƒ: ç½²åæ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
                return true;
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        async function processRedirect() {
            try {
                console.log('ğŸ” ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†é–‹å§‹');
                console.log('Token:', token);
                console.log('Signature:', sig);
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ã¨ç½²åã®å­˜åœ¨ç¢ºèª
                if (!token || !sig) {
                    throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯ç½²åãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }
                
                // ç½²åæ¤œè¨¼
                const isValid = await verifyToken(token, sig);
                if (!isValid) {
                    throw new Error('ç½²åæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‡ã‚³ãƒ¼ãƒ‰
                const payload = atob(token);
                console.log('Decoded payload:', payload);
                const [targetUrl, expiresAt] = payload.split('|');
                
                console.log('Target URL:', targetUrl);
                console.log('Expires at:', new Date(parseInt(expiresAt)).toLocaleString('ja-JP'));
                console.log('Current time:', new Date().toLocaleString('ja-JP'));
                
                // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                if (Date.now() > parseInt(expiresAt)) {
                    throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™');
                }
                
                // iframeã§è¡¨ç¤º
                const iframe = document.getElementById('targetFrame');
                const loadingContainer = document.getElementById('loadingContainer');
                
                console.log('âœ… æ¤œè¨¼æˆåŠŸï¼iframeã§è¡¨ç¤ºã—ã¾ã™:', targetUrl);
                
                iframe.src = targetUrl;
                iframe.classList.add('active');
                loadingContainer.style.display = 'none';
                
                console.log('ğŸ‰ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæˆåŠŸï¼');
                
            } catch (error) {
                console.error('Redirect error:', error);
                showError(error.message);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            errorMessage.textContent = message;
        }
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            window.history.back();
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‡¦ç†é–‹å§‹
        document.addEventListener('DOMContentLoaded', processRedirect);
    </script>
</body>
</html>
