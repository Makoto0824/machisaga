<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¾ã¡ã‚µãƒ¼ã‚¬ - ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            text-align: center;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
        }
        
        .logo {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            font-size: 1.1rem;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .manual-link {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .manual-link a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
        }
        
        .manual-link a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .logo {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ° ã¾ã¡ã‚µãƒ¼ã‚¬</div>
        <div class="subtitle">åœ°åŸŸå…±å‰µã‚µãƒãƒ¼ãƒˆã‚²ãƒ¼ãƒ </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <span>å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’æº–å‚™ä¸­...</span>
        </div>
        
        <div class="status" id="statusMessage">
            ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...
        </div>
        
        <div class="manual-link" id="manualLink" style="display: none;">
            <p>è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯ã€ä¸‹è¨˜ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š</p>
            <a href="#" id="manualRedirectLink">ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã¸é€²ã‚€</a>
        </div>
    </div>

    <script>
        // å¯¾è±¡URLç®¡ç†ï¼ˆ9å€‹ã®ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆURLï¼‰
        const TARGET_URLS = {
            // ã¾ã¡ã‚µãƒ¼ã‚¬ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆMSCå ±é…¬é †ï¼‰
            'event_1msc': 'https://play.ttt.games/worlds/machi-saga/events/b-mjFuRIEBL3xROr64xXA3qaSkZ5L926lSWCOXVtH60/checkin',
            'event_4msc': 'https://play.ttt.games/worlds/machi-saga/events/iZP-oFgwKs-rwFFVToqXkV488vnDHjyxIPF_hZ5y8MM/checkin',
            'event_6msc': 'https://play.ttt.games/worlds/machi-saga/events/x2pNQFx8ChWMoYPfgrXopstCgZ9HMF8JCPpNXmyXpn0/checkin',
            'event_8msc': 'https://play.ttt.games/worlds/machi-saga/events/Ti0h_WV3B8OiAXAi-vxtodyw6wAyT35MHRGcsCBuh0g/checkin',
            'event_10msc': 'https://play.ttt.games/worlds/machi-saga/events/17VlTOfDKjp6tqoAnuXxlgvsE4wRofg2Hz1i_rr_5Fc/checkin',
            'event_12msc': 'https://play.ttt.games/worlds/machi-saga/events/MyKXAlK_qOWpn9hKrZEWrQKypMoE8Ess9C1PhKBXg0A/checkin',
            'event_14msc': 'https://play.ttt.games/worlds/machi-saga/events/CrXfZStcu7XMtyDI77JE5lKlk7RYsZVcF5Xdk2XyiB0/checkin',
            'event_16msc': 'https://play.ttt.games/worlds/machi-saga/events/in7B9olSOc9H-W7yoxpV3T9WFJQwgM9vYUVrkKyHgBU/checkin',
            'event_21msc': 'https://play.ttt.games/worlds/machi-saga/events/WsDzeA-BjEOjN833J0-tTzRDHnnLLzFMytiCf5gseD4/checkin'
        };
        
        // API ãƒ™ãƒ¼ã‚¹URL
        const API_BASE = window.location.origin;
        
        // å¯¾è±¡URLæ±ºå®š
        function getTargetUrl() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const targetKey = urlParams.get('target');
            
            // ãƒãƒƒã‚·ãƒ¥ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            const hashTarget = window.location.hash.substring(1);
            
            const key = targetKey || hashTarget || 'event_21msc'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœ€é«˜å ±é…¬ã‚¤ãƒ™ãƒ³ãƒˆ
            const targetUrl = TARGET_URLS[key];
            
            if (!targetUrl) {
                throw new Error(`ç„¡åŠ¹ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ¼: ${key}`);
            }
            
            return {
                key: key,
                url: targetUrl
            };
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        let targetInfo;
        try {
            targetInfo = getTargetUrl();
            console.log('Entry page loaded:', {
                targetKey: targetInfo.key,
                targetUrl: targetInfo.url,
                apiBase: API_BASE,
                userAgent: navigator.userAgent,
                availableTargets: Object.keys(TARGET_URLS)
            });
        } catch (error) {
            console.error('Target URL resolution error:', error);
        }
        
        // è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œ
        async function autoRedirect() {
            const statusEl = document.getElementById('statusMessage');
            const loadingEl = document.getElementById('loadingIndicator');
            const manualEl = document.getElementById('manualLink');
            const manualLinkEl = document.getElementById('manualRedirectLink');
            
            try {
                // Step 0: å¯¾è±¡URLå–å¾—
                const targetInfo = getTargetUrl();
                
                // Step 1: ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
                statusEl.textContent = `ã‚»ã‚­ãƒ¥ã‚¢ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆä¸­... (${targetInfo.key})`;
                statusEl.className = 'status';
                
                const apiUrl = `${API_BASE}/api/generate-token?url=${encodeURIComponent(targetInfo.url)}`;
                console.log('API Request:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // Step 2: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œ
                const redirectUrl = `${API_BASE}${data.url}`;
                
                statusEl.textContent = 'âœ… ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆå®Œäº†ï¼ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...';
                statusEl.className = 'status success';
                
                // æ‰‹å‹•ãƒªãƒ³ã‚¯ã‚’è¨­å®šï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
                manualLinkEl.href = redirectUrl;
                
                console.log('Redirecting to:', redirectUrl);
                
                // çŸ­ã„é…å»¶å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1000);
                
            } catch (error) {
                console.error('Auto-redirect error:', error);
                
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                loadingEl.style.display = 'none';
                statusEl.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusEl.className = 'status error';
                
                // æ‰‹å‹•ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
                manualEl.style.display = 'block';
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…ƒã®URLï¼ˆå¯¾è±¡URLå–å¾—ã‚’å†è©¦è¡Œï¼‰
                try {
                    const fallbackInfo = getTargetUrl();
                    manualLinkEl.href = fallbackInfo.url;
                } catch (fallbackError) {
                    console.error('Fallback URL error:', fallbackError);
                    manualLinkEl.href = TARGET_URLS.event_21msc; // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                }
            }
        }
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ10ç§’å¾Œï¼‰
        setTimeout(() => {
            const loadingEl = document.getElementById('loadingIndicator');
            const manualEl = document.getElementById('manualLink');
            const manualLinkEl = document.getElementById('manualRedirectLink');
            
            if (loadingEl.style.display !== 'none') {
                loadingEl.style.display = 'none';
                manualEl.style.display = 'block';
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®å¯¾è±¡URLè¨­å®š
                try {
                    const timeoutInfo = getTargetUrl();
                    manualLinkEl.href = timeoutInfo.url;
                } catch (timeoutError) {
                    console.error('Timeout URL error:', timeoutError);
                    manualLinkEl.href = TARGET_URLS.event_21msc; // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                }
                
                document.getElementById('statusMessage').textContent = 'âš ï¸ è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
                document.getElementById('statusMessage').className = 'status error';
            }
        }, 10000);
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting auto-redirect...');
            autoRedirect();
        });
        
        // ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³å¯¾å¿œ
        window.addEventListener('beforeunload', () => {
            console.log('User navigating away from entry page');
        });
    </script>
</body>
</html>
