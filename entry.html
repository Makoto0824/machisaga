<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>まちサーガ - イベント参加</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            text-align: center;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
        }
        
        .logo {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            font-size: 1.1rem;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .manual-link {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .manual-link a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
        }
        
        .manual-link a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .logo {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">🏰 まちサーガ</div>
        <div class="subtitle">地域共創サポートゲーム</div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <span>安全なアクセスを準備中...</span>
        </div>
        
        <div class="status" id="statusMessage">
            トークンを生成しています...
        </div>
        
        <div class="manual-link" id="manualLink" style="display: none;">
            <p>自動リダイレクトに失敗した場合は、下記リンクをクリックしてください：</p>
            <a href="#" id="manualRedirectLink">イベントページへ進む</a>
        </div>
    </div>

    <script>
        // 対象URL管理（9個のまちサーガイベントURL）
        const TARGET_URLS = {
            // まちサーガイベント（MSC報酬順）
            'event_1msc': 'https://play.ttt.games/worlds/machi-saga/events/b-mjFuRIEBL3xROr64xXA3qaSkZ5L926lSWCOXVtH60/checkin',
            'event_4msc': 'https://play.ttt.games/worlds/machi-saga/events/iZP-oFgwKs-rwFFVToqXkV488vnDHjyxIPF_hZ5y8MM/checkin',
            'event_6msc': 'https://play.ttt.games/worlds/machi-saga/events/x2pNQFx8ChWMoYPfgrXopstCgZ9HMF8JCPpNXmyXpn0/checkin',
            'event_8msc': 'https://play.ttt.games/worlds/machi-saga/events/Ti0h_WV3B8OiAXAi-vxtodyw6wAyT35MHRGcsCBuh0g/checkin',
            'event_10msc': 'https://play.ttt.games/worlds/machi-saga/events/17VlTOfDKjp6tqoAnuXxlgvsE4wRofg2Hz1i_rr_5Fc/checkin',
            'event_12msc': 'https://play.ttt.games/worlds/machi-saga/events/MyKXAlK_qOWpn9hKrZEWrQKypMoE8Ess9C1PhKBXg0A/checkin',
            'event_14msc': 'https://play.ttt.games/worlds/machi-saga/events/CrXfZStcu7XMtyDI77JE5lKlk7RYsZVcF5Xdk2XyiB0/checkin',
            'event_16msc': 'https://play.ttt.games/worlds/machi-saga/events/in7B9olSOc9H-W7yoxpV3T9WFJQwgM9vYUVrkKyHgBU/checkin',
            'event_21msc': 'https://play.ttt.games/worlds/machi-saga/events/WsDzeA-BjEOjN833J0-tTzRDHnnLLzFMytiCf5gseD4/checkin'
        };
        
        // API ベースURL
        const API_BASE = window.location.origin;
        
        // 対象URL決定
        function getTargetUrl() {
            // URLパラメータから取得
            const urlParams = new URLSearchParams(window.location.search);
            const targetKey = urlParams.get('target');
            
            // ハッシュフラグメントから取得（フォールバック）
            const hashTarget = window.location.hash.substring(1);
            
            const key = targetKey || hashTarget || 'event_21msc'; // デフォルトは最高報酬イベント
            const targetUrl = TARGET_URLS[key];
            
            if (!targetUrl) {
                throw new Error(`無効なターゲットキー: ${key}`);
            }
            
            return {
                key: key,
                url: targetUrl
            };
        }
        
        // デバッグ情報
        let targetInfo;
        try {
            targetInfo = getTargetUrl();
            console.log('Entry page loaded:', {
                targetKey: targetInfo.key,
                targetUrl: targetInfo.url,
                apiBase: API_BASE,
                userAgent: navigator.userAgent,
                availableTargets: Object.keys(TARGET_URLS)
            });
        } catch (error) {
            console.error('Target URL resolution error:', error);
        }
        
        // 自動リダイレクト実行
        async function autoRedirect() {
            const statusEl = document.getElementById('statusMessage');
            const loadingEl = document.getElementById('loadingIndicator');
            const manualEl = document.getElementById('manualLink');
            const manualLinkEl = document.getElementById('manualRedirectLink');
            
            try {
                // Step 0: 対象URL取得
                const targetInfo = getTargetUrl();
                
                // Step 1: トークン生成
                statusEl.textContent = `セキュアトークンを生成中... (${targetInfo.key})`;
                statusEl.className = 'status';
                
                const apiUrl = `${API_BASE}/api/generate-token?url=${encodeURIComponent(targetInfo.url)}`;
                console.log('API Request:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'トークン生成に失敗しました');
                }
                
                // Step 2: リダイレクト実行
                const redirectUrl = `${API_BASE}${data.url}`;
                
                statusEl.textContent = '✅ トークン生成完了！リダイレクト中...';
                statusEl.className = 'status success';
                
                // 手動リンクを設定（バックアップ）
                manualLinkEl.href = redirectUrl;
                
                console.log('Redirecting to:', redirectUrl);
                
                // 短い遅延後にリダイレクト
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1000);
                
            } catch (error) {
                console.error('Auto-redirect error:', error);
                
                // エラー表示
                loadingEl.style.display = 'none';
                statusEl.textContent = `❌ エラー: ${error.message}`;
                statusEl.className = 'status error';
                
                // 手動リンクを表示
                manualEl.style.display = 'block';
                
                // フォールバック: 元のURL（対象URL取得を再試行）
                try {
                    const fallbackInfo = getTargetUrl();
                    manualLinkEl.href = fallbackInfo.url;
                } catch (fallbackError) {
                    console.error('Fallback URL error:', fallbackError);
                    manualLinkEl.href = TARGET_URLS.event_21msc; // 最終フォールバック
                }
            }
        }
        
        // タイムアウト処理（10秒後）
        setTimeout(() => {
            const loadingEl = document.getElementById('loadingIndicator');
            const manualEl = document.getElementById('manualLink');
            const manualLinkEl = document.getElementById('manualRedirectLink');
            
            if (loadingEl.style.display !== 'none') {
                loadingEl.style.display = 'none';
                manualEl.style.display = 'block';
                
                // タイムアウト時の対象URL設定
                try {
                    const timeoutInfo = getTargetUrl();
                    manualLinkEl.href = timeoutInfo.url;
                } catch (timeoutError) {
                    console.error('Timeout URL error:', timeoutError);
                    manualLinkEl.href = TARGET_URLS.event_21msc; // 最終フォールバック
                }
                
                document.getElementById('statusMessage').textContent = '⚠️ 自動リダイレクトがタイムアウトしました';
                document.getElementById('statusMessage').className = 'status error';
            }
        }, 10000);
        
        // ページ読み込み完了後に実行
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting auto-redirect...');
            autoRedirect();
        });
        
        // バックボタン対応
        window.addEventListener('beforeunload', () => {
            console.log('User navigating away from entry page');
        });
    </script>
</body>
</html>
